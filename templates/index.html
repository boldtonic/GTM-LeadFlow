<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTM Lead Finder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #0a0a0a;
            --surface: #141414;
            --surface-2: #1a1a1a;
            --border: #2a2a2a;
            --text: #fafafa;
            --text-muted: #888;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            background: var(--surface-2);
            color: var(--text);
        }

        .nav-tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .api-status {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }

        .status-dot.active { background: var(--success); }
        .status-dot.inactive { background: var(--danger); }

        .main-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Form Panel */
        .form-panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            height: fit-content;
            position: sticky;
            top: 2rem;
        }

        .form-section {
            margin-bottom: 1.5rem;
        }

        .form-section h3 {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        label {
            display: block;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        input, textarea, select {
            width: 100%;
            padding: 0.75rem;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
            transition: border-color 0.2s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .checkbox-group input {
            width: auto;
            margin: 0;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-primary:disabled {
            background: var(--border);
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--surface-2);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* Progress */
        .progress-container {
            margin-top: 1rem;
            display: none;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            height: 4px;
            background: var(--surface-2);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Results Panel */
        .results-panel {
            min-height: 400px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .results-header h2 {
            font-size: 1.125rem;
            font-weight: 500;
        }

        .results-actions {
            display: flex;
            gap: 0.5rem;
        }

        .results-actions .btn {
            width: auto;
            padding: 0.5rem 1rem;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-card.high .stat-value { color: var(--success); }
        .stat-card.medium .stat-value { color: var(--warning); }
        .stat-card.low .stat-value { color: var(--text-muted); }

        /* Table */
        .table-container {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--surface-2);
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
            vertical-align: top;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: var(--surface-2);
        }

        .score-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .score-high { background: rgba(34, 197, 94, 0.2); color: var(--success); }
        .score-medium { background: rgba(234, 179, 8, 0.2); color: var(--warning); }
        .score-low { background: rgba(136, 136, 136, 0.2); color: var(--text-muted); }

        .lead-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .lead-category {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .lead-location {
            font-size: 0.875rem;
        }

        .lead-city {
            font-weight: 500;
        }

        .lead-address {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .contact-info a {
            color: var(--accent);
            text-decoration: none;
            display: block;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .contact-info a:hover {
            text-decoration: underline;
        }

        .social-links {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .social-links a {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .rating-star {
            color: var(--warning);
        }

        .reviews {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .fit-reasons {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .fit-reasons span {
            display: inline-block;
            background: var(--surface-2);
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
            margin: 0.125rem;
        }

        .actions-cell {
            white-space: nowrap;
        }

        .actions-cell a {
            color: var(--accent);
            text-decoration: none;
            font-size: 0.75rem;
            margin-right: 0.75rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.125rem;
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        /* Presets */
        .presets {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .preset-btn {
            padding: 0.375rem 0.75rem;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-btn:hover {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.1);
        }

        /* Tags input */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            padding: 0.5rem;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            min-height: 42px;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: var(--border);
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .tag-remove {
            cursor: pointer;
            opacity: 0.7;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        .tags-input {
            flex: 1;
            min-width: 100px;
            border: none !important;
            padding: 0.25rem !important;
            margin: 0 !important;
            background: transparent !important;
        }

        .tags-input:focus {
            outline: none;
        }

        /* Decision maker */
        .dm-info {
            font-size: 0.75rem;
        }

        .dm-name {
            font-weight: 500;
        }

        .dm-title {
            color: var(--text-muted);
        }

        .dm-email {
            color: var(--accent);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>üéØ GTM LeadFlow</h1>
            </div>
            <div class="api-status" id="apiStatus">
                <span><span class="status-dot inactive" id="googleStatus"></span>Google Places</span>
                <span><span class="status-dot inactive" id="apolloStatus"></span>Apollo</span>
                <span><span class="status-dot inactive" id="firecrawlStatus"></span>Firecrawl</span>
            </div>
        </header>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('finder')">Lead Finder</button>
            <button class="nav-tab" onclick="switchTab('brief')">GTM Brief</button>
            <button class="nav-tab" onclick="switchTab('discovery')">Prospect Discovery</button>
            <button class="nav-tab" onclick="switchTab('enrichment')">Enrichment</button>
        </div>

        <!-- TAB: Lead Finder (Original) -->
        <div id="tab-finder" class="tab-content active">
        <div class="main-grid">
            <!-- Form Panel -->
            <div class="form-panel">
                <div class="form-section">
                    <h3>Client Brief</h3>
                    <label>Brand Name</label>
                    <input type="text" id="brandName" placeholder="e.g., Andr√©s Machado">

                    <label>Brand Website</label>
                    <input type="url" id="brandWebsite" placeholder="https://...">

                    <label>Target Segment</label>
                    <select id="segment">
                        <option value="mid-premium">Mid-Premium</option>
                        <option value="premium">Premium / Luxury</option>
                        <option value="mass-market">Mass Market</option>
                    </select>
                </div>

                <div class="form-section">
                    <h3>Search Queries</h3>
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                        One query per line. Include location in query.
                    </p>
                    <div class="presets">
                        <button class="preset-btn" onclick="loadPreset('warsaw-shoes')">Warsaw Shoes</button>
                        <button class="preset-btn" onclick="loadPreset('krakow-fashion')">Krakow Fashion</button>
                        <button class="preset-btn" onclick="loadPreset('madrid-boutiques')">Madrid Boutiques</button>
                    </div>
                    <textarea id="queries" placeholder="multi-brand shoe store Warsaw&#10;women's footwear boutique Warsaw&#10;butik obuwniczy Warszawa"></textarea>
                </div>

                <div class="form-section">
                    <h3>Filters</h3>
                    <label>Min Rating</label>
                    <input type="number" id="minRating" value="4.0" step="0.1" min="0" max="5">

                    <label>Positive Signals (comma-separated)</label>
                    <input type="text" id="positiveSignals" placeholder="boutique, premium, designer, leather">

                    <label>Negative Signals (comma-separated)</label>
                    <input type="text" id="negativeSignals" placeholder="discount, outlet, sports, children">

                    <label>Exclude Brands (comma-separated)</label>
                    <input type="text" id="excludeBrands" placeholder="CCC, Deichmann, Eobuwie">
                </div>

                <div class="form-section">
                    <h3>Options</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="enrichLeads" checked>
                        <label for="enrichLeads" style="margin: 0;">Enrich leads (website + Apollo)</label>
                    </div>
                </div>

                <button class="btn btn-primary" id="searchBtn" onclick="startSearch()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Find Leads
                </button>

                <button class="btn btn-secondary" id="cancelBtn" onclick="cancelSearch()" style="display: none; margin-top: 0.5rem;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="m15 9-6 6"></path>
                        <path d="m9 9 6 6"></path>
                    </svg>
                    Cancel Search
                </button>

                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Initializing...</div>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="results-panel">
                <div class="results-header">
                    <h2>Results</h2>
                    <div class="results-actions" id="resultsActions" style="display: none;">
                        <button class="btn btn-secondary" onclick="exportCSV()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Export CSV
                        </button>
                    </div>
                </div>

                <div class="stats-grid" id="statsGrid" style="display: none;">
                    <div class="stat-card">
                        <div class="stat-value" id="totalLeads">0</div>
                        <div class="stat-label">Total Leads</div>
                    </div>
                    <div class="stat-card high">
                        <div class="stat-value" id="highFit">0</div>
                        <div class="stat-label">High Fit (70+)</div>
                    </div>
                    <div class="stat-card medium">
                        <div class="stat-value" id="mediumFit">0</div>
                        <div class="stat-label">Medium (50-69)</div>
                    </div>
                    <div class="stat-card low">
                        <div class="stat-value" id="lowFit">0</div>
                        <div class="stat-label">Low (&lt;50)</div>
                    </div>
                </div>

                <div class="table-container" id="resultsTable" style="display: none;">
                    <table>
                        <thead>
                            <tr>
                                <th>Score</th>
                                <th>Business</th>
                                <th>Location</th>
                                <th>Contact</th>
                                <th>Rating</th>
                                <th>Decision Maker</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leadsBody">
                        </tbody>
                    </table>
                </div>

                <div class="empty-state" id="emptyState">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <h3>No leads yet</h3>
                    <p>Configure your search and click "Find Leads" to get started.</p>
                </div>
            </div>
        </div>
        </div><!-- End tab-finder -->

        <!-- TAB: GTM Brief -->
        <div id="tab-brief" class="tab-content">
            <div class="main-grid">
                <div class="form-panel">
                    <div class="form-section">
                        <h3>Generate GTM Brief</h3>
                        <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 1rem;">
                            Analyze any company website to generate a complete Go-To-Market strategy with ICP, personas, and outreach angles.
                        </p>
                        <label>Company Website URL</label>
                        <input type="url" id="briefUrl" placeholder="https://example.com">
                        <button class="btn btn-primary" onclick="generateBrief()" id="briefBtn" style="width: 100%; margin-top: 1rem;">
                            Generate GTM Brief
                        </button>
                    </div>
                    <div id="briefProgress" style="display: none;">
                        <div class="progress-indicator">
                            <div class="spinner"></div>
                            <span id="briefStep">Analyzing website...</span>
                        </div>
                    </div>
                </div>
                <div class="results-panel">
                    <div class="results-header">
                        <h2>GTM Brief</h2>
                    </div>
                    <div id="briefResults" class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <h3>No brief generated</h3>
                        <p>Enter a company URL to generate a GTM brief.</p>
                    </div>
                </div>
            </div>
        </div><!-- End tab-brief -->

        <!-- TAB: Prospect Discovery -->
        <div id="tab-discovery" class="tab-content">
            <div class="main-grid">
                <div class="form-panel">
                    <div class="form-section">
                        <h3>Discover Prospects</h3>
                        <label>Discovery Mode</label>
                        <select id="discoveryMode">
                            <option value="smart">Smart Search (Recommended)</option>
                            <option value="web">Web Search (Firecrawl)</option>
                            <option value="maps">Google Maps URL</option>
                        </select>

                        <div id="searchQuerySection">
                            <label>Search Query</label>
                            <input type="text" id="discoveryQuery" placeholder="e.g., SaaS companies in Austin">
                            <label>Location</label>
                            <input type="text" id="discoveryLocation" placeholder="e.g., Austin, TX">
                        </div>

                        <div id="mapsUrlSection" style="display: none;">
                            <label>Google Maps URL</label>
                            <input type="url" id="mapsUrl" placeholder="Paste Google Maps search URL">
                            <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem;">
                                Search on Google Maps, copy the URL, and paste it here.
                            </p>
                        </div>

                        <button class="btn btn-primary" onclick="discoverProspects()" id="discoverBtn" style="width: 100%; margin-top: 1rem;">
                            Discover Prospects
                        </button>
                    </div>
                    <div id="discoveryProgress" style="display: none;">
                        <div class="progress-indicator">
                            <div class="spinner"></div>
                            <span id="discoveryStep">Searching...</span>
                        </div>
                    </div>
                </div>
                <div class="results-panel">
                    <div class="results-header">
                        <h2>Discovered Prospects</h2>
                        <span id="discoveryCount" class="results-count">0 prospects</span>
                    </div>
                    <div id="discoveryResults" class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <h3>No prospects yet</h3>
                        <p>Configure your search to discover prospects.</p>
                    </div>
                </div>
            </div>
        </div><!-- End tab-discovery -->

        <!-- TAB: Enrichment -->
        <div id="tab-enrichment" class="tab-content">
            <div class="main-grid">
                <div class="form-panel">
                    <div class="form-section">
                        <h3>Enrich Companies</h3>
                        <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 1rem;">
                            Get detailed company info: emails, social links, tech stack, and decision makers.
                        </p>
                        <label>Domains (one per line)</label>
                        <textarea id="enrichDomains" rows="6" placeholder="example.com&#10;another-company.com&#10;startup.io"></textarea>
                        <button class="btn btn-primary" onclick="enrichCompanies()" id="enrichBtn" style="width: 100%; margin-top: 1rem;">
                            Enrich Companies
                        </button>
                    </div>
                    <div id="enrichProgress" style="display: none;">
                        <div class="progress-indicator">
                            <div class="spinner"></div>
                            <span id="enrichStep">Enriching...</span>
                        </div>
                    </div>
                </div>
                <div class="results-panel">
                    <div class="results-header">
                        <h2>Enriched Companies</h2>
                        <button class="btn btn-secondary" onclick="exportEnriched()" id="exportEnrichedBtn" style="display: none;">Export CSV</button>
                    </div>
                    <div id="enrichResults" class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        <h3>No companies enriched</h3>
                        <p>Enter domains above to enrich company data.</p>
                    </div>
                </div>
            </div>
        </div><!-- End tab-enrichment -->

    </div>

    <script>
        let currentJobId = null;
        let pollInterval = null;
        let discoveredProspects = [];
        let enrichedCompanies = [];

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));

            // Show selected tab
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Discovery mode toggle
        document.addEventListener('DOMContentLoaded', function() {
            const modeSelect = document.getElementById('discoveryMode');
            if (modeSelect) {
                modeSelect.addEventListener('change', function() {
                    const searchSection = document.getElementById('searchQuerySection');
                    const mapsSection = document.getElementById('mapsUrlSection');
                    if (this.value === 'maps') {
                        searchSection.style.display = 'none';
                        mapsSection.style.display = 'block';
                    } else {
                        searchSection.style.display = 'block';
                        mapsSection.style.display = 'none';
                    }
                });
            }
        });

        // GTM Brief Generation
        async function generateBrief() {
            const url = document.getElementById('briefUrl').value.trim();
            if (!url) {
                alert('Please enter a company URL');
                return;
            }

            const btn = document.getElementById('briefBtn');
            const progress = document.getElementById('briefProgress');
            const results = document.getElementById('briefResults');

            btn.disabled = true;
            btn.textContent = 'Generating...';
            progress.style.display = 'block';

            try {
                const resp = await fetch('/api/brief', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await resp.json();

                if (data.success) {
                    displayBrief(data.brief);
                } else {
                    results.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${data.error}</p></div>`;
                }
            } catch (e) {
                results.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${e.message}</p></div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate GTM Brief';
                progress.style.display = 'none';
            }
        }

        function displayBrief(brief) {
            const results = document.getElementById('briefResults');
            results.innerHTML = `
                <div style="padding: 1rem;">
                    <div style="background: var(--surface-2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 0.5rem;">${brief.company?.name || 'Company'}</h3>
                        <p style="color: var(--text-muted);">${brief.company?.tagline || ''}</p>
                        <p style="margin-top: 0.5rem;"><strong>Industry:</strong> ${brief.company?.industry || 'N/A'}</p>
                    </div>
                    ${brief.value_proposition ? `
                    <div style="background: var(--surface-2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.5rem;">Value Proposition</h4>
                        <p>${brief.value_proposition}</p>
                    </div>` : ''}
                    ${brief.icp ? `
                    <div style="background: var(--surface-2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.5rem;">Ideal Customer Profile</h4>
                        <p><strong>Industries:</strong> ${brief.icp.industries?.join(', ') || 'N/A'}</p>
                        <p><strong>Company Size:</strong> ${brief.icp.company_size || 'N/A'}</p>
                        <p><strong>Pain Points:</strong> ${brief.icp.pain_points?.join(', ') || 'N/A'}</p>
                    </div>` : ''}
                    ${brief.search_queries?.length ? `
                    <div style="background: var(--surface-2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 0.5rem;">Suggested Search Queries</h4>
                        <ul style="margin-left: 1rem;">
                            ${brief.search_queries.map(q => `<li>${q}</li>`).join('')}
                        </ul>
                        <button class="btn btn-secondary" onclick="useQueriesForDiscovery()" style="margin-top: 1rem;">
                            Use for Discovery ‚Üí
                        </button>
                    </div>` : ''}
                </div>
            `;
        }

        function useQueriesForDiscovery() {
            // Switch to discovery tab with queries
            switchTab('discovery');
            document.querySelectorAll('.nav-tab')[2].classList.add('active');
            document.querySelectorAll('.nav-tab')[1].classList.remove('active');
        }

        // Prospect Discovery
        async function discoverProspects() {
            const mode = document.getElementById('discoveryMode').value;
            const btn = document.getElementById('discoverBtn');
            const progress = document.getElementById('discoveryProgress');
            const results = document.getElementById('discoveryResults');

            let payload = { mode };

            if (mode === 'maps') {
                const mapsUrl = document.getElementById('mapsUrl').value.trim();
                if (!mapsUrl) {
                    alert('Please enter a Google Maps URL');
                    return;
                }
                payload.mapsUrl = mapsUrl;
            } else {
                const query = document.getElementById('discoveryQuery').value.trim();
                const location = document.getElementById('discoveryLocation').value.trim();
                if (!query) {
                    alert('Please enter a search query');
                    return;
                }
                payload.query = query;
                payload.location = location;
            }

            btn.disabled = true;
            btn.textContent = 'Searching...';
            progress.style.display = 'block';

            try {
                const resp = await fetch('/api/discover', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();

                if (data.success) {
                    discoveredProspects = data.prospects;
                    displayDiscoveredProspects(data.prospects);
                    document.getElementById('discoveryCount').textContent = `${data.prospects.length} prospects`;
                } else {
                    results.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${data.error}</p></div>`;
                }
            } catch (e) {
                results.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${e.message}</p></div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Discover Prospects';
                progress.style.display = 'none';
            }
        }

        function displayDiscoveredProspects(prospects) {
            const results = document.getElementById('discoveryResults');
            if (!prospects.length) {
                results.innerHTML = '<div class="empty-state"><h3>No prospects found</h3></div>';
                return;
            }

            results.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <button class="btn btn-secondary" onclick="sendToEnrichment()">Send to Enrichment ‚Üí</button>
                </div>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Location</th>
                            <th>Website</th>
                            <th>Rating</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${prospects.map(p => `
                            <tr>
                                <td><strong>${p.name}</strong></td>
                                <td>${p.category || '-'}</td>
                                <td>${p.location || '-'}</td>
                                <td>${p.website ? `<a href="${p.website}" target="_blank">Visit</a>` : '-'}</td>
                                <td>${p.rating ? p.rating + '‚≠ê' : '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function sendToEnrichment() {
            const domains = discoveredProspects
                .filter(p => p.website)
                .map(p => {
                    try {
                        return new URL(p.website).hostname.replace('www.', '');
                    } catch { return null; }
                })
                .filter(d => d);

            document.getElementById('enrichDomains').value = domains.join('\n');
            switchTab('enrichment');
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab')[3].classList.add('active');
        }

        // Company Enrichment
        async function enrichCompanies() {
            const domainsText = document.getElementById('enrichDomains').value.trim();
            if (!domainsText) {
                alert('Please enter at least one domain');
                return;
            }

            const domains = domainsText.split('\n').map(d => d.trim()).filter(d => d);
            const btn = document.getElementById('enrichBtn');
            const progress = document.getElementById('enrichProgress');
            const results = document.getElementById('enrichResults');
            const step = document.getElementById('enrichStep');

            btn.disabled = true;
            progress.style.display = 'block';
            enrichedCompanies = [];

            for (let i = 0; i < domains.length; i++) {
                step.textContent = `Enriching ${i + 1}/${domains.length}: ${domains[i]}`;

                try {
                    const resp = await fetch('/api/enrich', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ domain: domains[i] })
                    });
                    const data = await resp.json();

                    if (data.success) {
                        enrichedCompanies.push(data.data);
                    } else {
                        enrichedCompanies.push({ domain: domains[i], error: data.error });
                    }
                } catch (e) {
                    enrichedCompanies.push({ domain: domains[i], error: e.message });
                }
            }

            displayEnrichedCompanies(enrichedCompanies);
            btn.disabled = false;
            btn.textContent = 'Enrich Companies';
            progress.style.display = 'none';
            document.getElementById('exportEnrichedBtn').style.display = 'block';
        }

        function displayEnrichedCompanies(companies) {
            const results = document.getElementById('enrichResults');

            results.innerHTML = `
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Domain</th>
                            <th>Name</th>
                            <th>Industry</th>
                            <th>Email</th>
                            <th>LinkedIn</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${companies.map(c => `
                            <tr>
                                <td><strong>${c.domain}</strong></td>
                                <td>${c.name || '-'}</td>
                                <td>${c.industry || '-'}</td>
                                <td>${c.email || '-'}</td>
                                <td>${c.linkedin ? `<a href="${c.linkedin}" target="_blank">View</a>` : '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function exportEnriched() {
            const headers = ['Domain', 'Name', 'Description', 'Industry', 'Email', 'Phone', 'LinkedIn', 'Twitter'];
            const rows = enrichedCompanies.map(c => [
                c.domain || '',
                c.name || '',
                c.description || '',
                c.industry || '',
                c.email || '',
                c.phone || '',
                c.linkedin || '',
                c.twitter || ''
            ]);

            const csv = [headers, ...rows].map(r => r.map(v => `"${v}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'enriched_companies.csv';
            a.click();
        }

        // Presets
        const presets = {
            'warsaw-shoes': {
                queries: `multi-brand shoe store Warsaw
women's footwear boutique Warsaw
sklep z obuwiem damskim Warszawa
butik obuwniczy Warszawa
buty damskie premium Warszawa
obuwie komfortowe Warszawa
shoe store Mokotow Warsaw
women's shoes Srodmiescie Warsaw`,
                positiveSignals: 'boutique, butik, premium, designer, comfortable, komfortowe, leather, sk√≥ra, elegant, damskie',
                negativeSignals: 'discount, outlet, sports, sportowe, sneakers, children, dzieciƒôce, second hand',
                excludeBrands: 'CCC, Deichmann, Eobuwie, Ry≈Çko, Wojas, Badura'
            },
            'krakow-fashion': {
                queries: `fashion boutique Krakow
women's clothing store Krakow old town
butik damski Krak√≥w
sklep z modƒÖ Krak√≥w Stare Miasto
multi-brand boutique Kazimierz Krakow`,
                positiveSignals: 'boutique, butik, premium, designer, multi-brand, elegant',
                negativeSignals: 'discount, outlet, vintage, second hand',
                excludeBrands: 'H&M, Zara, Reserved, Mohito'
            },
            'madrid-boutiques': {
                queries: `tienda de zapatos mujer Madrid
boutique calzado Madrid Salamanca
zapater√≠a premium Madrid
multi-marca zapatos Madrid
tienda zapatos dise√±o Madrid`,
                positiveSignals: 'boutique, premium, dise√±o, lujo, elegante, piel',
                negativeSignals: 'outlet, descuento, deportivo, ni√±os',
                excludeBrands: 'Marypaz, Merkal, Ulanka, Krack'
            }
        };

        function loadPreset(name) {
            const preset = presets[name];
            if (preset) {
                document.getElementById('queries').value = preset.queries;
                document.getElementById('positiveSignals').value = preset.positiveSignals;
                document.getElementById('negativeSignals').value = preset.negativeSignals;
                document.getElementById('excludeBrands').value = preset.excludeBrands;
            }
        }

        // Check API config on load
        async function checkConfig() {
            try {
                const resp = await fetch('/api/config');
                const config = await resp.json();

                document.getElementById('googleStatus').className =
                    'status-dot ' + (config.google_places ? 'active' : 'inactive');
                document.getElementById('apolloStatus').className =
                    'status-dot ' + (config.apollo ? 'active' : 'inactive');
                document.getElementById('firecrawlStatus').className =
                    'status-dot ' + (config.firecrawl ? 'active' : 'inactive');
            } catch (e) {
                console.error('Config check failed:', e);
            }
        }

        async function startSearch() {
            const queries = document.getElementById('queries').value.trim().split('\n').filter(q => q.trim());

            if (queries.length === 0) {
                alert('Please enter at least one search query');
                return;
            }

            const config = {
                brand_name: document.getElementById('brandName').value,
                brand_website: document.getElementById('brandWebsite').value,
                segment: document.getElementById('segment').value,
                queries: queries,
                min_rating: parseFloat(document.getElementById('minRating').value) || 4.0,
                positive_signals: document.getElementById('positiveSignals').value.split(',').map(s => s.trim()).filter(Boolean),
                negative_signals: document.getElementById('negativeSignals').value.split(',').map(s => s.trim()).filter(Boolean),
                exclude_brands: document.getElementById('excludeBrands').value.split(',').map(s => s.trim()).filter(Boolean),
                enrich: document.getElementById('enrichLeads').checked
            };

            // Start search
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('cancelBtn').style.display = 'block';
            document.getElementById('progressContainer').classList.add('active');
            document.getElementById('emptyState').style.display = 'none';

            try {
                const resp = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const data = await resp.json();
                currentJobId = data.job_id;

                // Start polling for status
                pollInterval = setInterval(pollStatus, 1000);

            } catch (e) {
                console.error('Search failed:', e);
                alert('Search failed: ' + e.message);
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('cancelBtn').style.display = 'none';
                document.getElementById('progressContainer').classList.remove('active');
            }
        }

        async function pollStatus() {
            if (!currentJobId) return;

            try {
                const resp = await fetch(`/api/status/${currentJobId}`);
                const status = await resp.json();

                // Update progress
                document.getElementById('progressFill').style.width = status.progress + '%';
                document.getElementById('progressText').textContent = status.step;

                if (status.status === 'completed' || status.status === 'error' || status.status === 'cancelled') {
                    clearInterval(pollInterval);
                    document.getElementById('searchBtn').disabled = false;
                    document.getElementById('cancelBtn').style.display = 'none';

                    if (status.status === 'completed' && status.leads && status.leads.length > 0) {
                        displayResults(status.leads);
                    } else if (status.status === 'cancelled') {
                        document.getElementById('progressContainer').classList.remove('active');
                        document.getElementById('emptyState').style.display = 'block';
                        document.getElementById('emptyState').querySelector('h3').textContent = 'Search cancelled';
                        document.getElementById('emptyState').querySelector('p').textContent = 'The search was cancelled. Click "Find Leads" to start a new search.';
                    } else if (status.status === 'error') {
                        alert('Search error: ' + status.step);
                        document.getElementById('progressContainer').classList.remove('active');
                        document.getElementById('emptyState').style.display = 'block';
                    } else {
                        document.getElementById('progressContainer').classList.remove('active');
                        document.getElementById('emptyState').style.display = 'block';
                        document.getElementById('emptyState').querySelector('h3').textContent = 'No results found';
                        document.getElementById('emptyState').querySelector('p').textContent = 'Try different search queries or locations.';
                    }
                }

            } catch (e) {
                console.error('Poll failed:', e);
            }
        }

        function displayResults(leads) {
            // Hide progress, show results
            document.getElementById('progressContainer').classList.remove('active');
            document.getElementById('statsGrid').style.display = 'grid';
            document.getElementById('resultsTable').style.display = 'block';
            document.getElementById('resultsActions').style.display = 'flex';

            // Calculate stats
            const highFit = leads.filter(l => l.fit_score >= 70).length;
            const mediumFit = leads.filter(l => l.fit_score >= 50 && l.fit_score < 70).length;
            const lowFit = leads.filter(l => l.fit_score < 50).length;

            document.getElementById('totalLeads').textContent = leads.length;
            document.getElementById('highFit').textContent = highFit;
            document.getElementById('mediumFit').textContent = mediumFit;
            document.getElementById('lowFit').textContent = lowFit;

            // Build table
            const tbody = document.getElementById('leadsBody');
            tbody.innerHTML = '';

            leads.forEach(lead => {
                const scoreClass = lead.fit_score >= 70 ? 'score-high' :
                                   lead.fit_score >= 50 ? 'score-medium' : 'score-low';

                const dm = lead.decision_makers && lead.decision_makers[0];
                const email = lead.emails_found && lead.emails_found[0];
                const instagram = lead.social_links && lead.social_links.instagram;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="score-badge ${scoreClass}">${lead.fit_score}</div>
                    </td>
                    <td>
                        <div class="lead-name">${escapeHtml(lead.name)}</div>
                        <div class="lead-category">${escapeHtml(lead.category)}</div>
                        <div class="fit-reasons">
                            ${lead.fit_reasons.slice(0, 3).map(r => `<span>${escapeHtml(r)}</span>`).join('')}
                        </div>
                    </td>
                    <td>
                        <div class="lead-location">
                            <div class="lead-city">${escapeHtml(lead.city || lead.country || '-')}</div>
                            <div class="lead-address">${escapeHtml(lead.address_full || '').substring(0, 50)}</div>
                        </div>
                    </td>
                    <td>
                        <div class="contact-info">
                            ${lead.phone ? `<a href="tel:${lead.phone}">${escapeHtml(lead.phone)}</a>` : ''}
                            ${lead.website ? `<a href="${lead.website}" target="_blank">Website</a>` : ''}
                            ${email ? `<a href="mailto:${email}">${escapeHtml(email)}</a>` : ''}
                        </div>
                        <div class="social-links">
                            ${instagram ? `<a href="https://instagram.com/${instagram}" target="_blank">@${instagram}</a>` : ''}
                            ${lead.linkedin_url ? `<a href="${lead.linkedin_url}" target="_blank">LinkedIn</a>` : ''}
                        </div>
                    </td>
                    <td>
                        <div class="rating">
                            <span class="rating-star">‚òÖ</span>
                            ${lead.rating || '-'}
                        </div>
                        <div class="reviews">${lead.reviews_count || 0} reviews</div>
                    </td>
                    <td>
                        ${dm ? `
                            <div class="dm-info">
                                <div class="dm-name">${escapeHtml(dm.name || '-')}</div>
                                <div class="dm-title">${escapeHtml(dm.title || '')}</div>
                                ${dm.email ? `<a class="dm-email" href="mailto:${dm.email}">${escapeHtml(dm.email)}</a>` : ''}
                            </div>
                        ` : '<span style="color: var(--text-muted)">-</span>'}
                    </td>
                    <td class="actions-cell">
                        <a href="${lead.google_maps_url}" target="_blank">Maps</a>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function cancelSearch() {
            if (!currentJobId) return;

            try {
                await fetch(`/api/cancel/${currentJobId}`, { method: 'POST' });
                document.getElementById('progressText').textContent = 'Cancelling...';
            } catch (e) {
                console.error('Cancel failed:', e);
            }
        }

        function exportCSV() {
            if (currentJobId) {
                window.location.href = `/api/export/${currentJobId}`;
            }
        }

        // Initialize
        checkConfig();
    </script>
</body>
</html>
